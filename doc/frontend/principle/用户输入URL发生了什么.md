## 用户在浏览器输入 URL，发生了什么？

### 一、网络通信阶段：从 URL 到数据包

#### 1. URL 解析与预处理

- **浏览器自动补全协议**：如 `https://`，并通过 **HSTS 预加载列表** 强制 HTTPS，防止中间人攻击。
- **检查 Service Worker 缓存**：若注册了 Service Worker 且命中缓存策略（如 Cache API），直接拦截请求返回缓存。

#### 2. DNS 解析：从域名到 IP 的寻址

- **解析流程**：
  1. 浏览器缓存 → 系统缓存（如 `/etc/hosts`） → 本地 DNS 服务器（递归查询）。
- **DNS 优化**：
  - **预解析**：通过 `<link rel="dns-prefetch">` 提前解析页面中的外链域名。
  - **CDN 调度**：权威 DNS 通过 EDNS Client Subnet 返回离用户最近的 CDN 节点 IP。

#### 3. 建立连接：TCP 与 TLS 握手

- **TCP 三次握手**：1 个 RTT（Round-Trip Time）消耗，若启用 **TFO（TCP Fast Open）** 可减少延迟。
- **TLS 1.3 握手**：仅需 1 个 RTT（对比 TLS 1.2 的 2 个 RTT），支持 **0-RTT** 快速恢复会话。
- **协议升级**：若服务器支持 HTTP/2 或 HTTP/3（QUIC 协议），复用连接提升效率。

#### 4. 发送 HTTP 请求

- **请求头关键字段**：
  - `Cookie`（SameSite 防御 CSRF）。
  - `Accept-Encoding`（支持 Brotli 压缩）。
  - `Cache-Control`（协商缓存策略）。
- **性能优化**：
  - HTTP/2 多路复用避免队头阻塞。
  - 头部压缩（HPACK）减少传输量。

---

### 二、服务器处理阶段：从请求到响应

#### 1. 反向代理与负载均衡

- **请求转发**：请求可能被 Nginx 转发到后端服务器集群。
- **负载均衡算法**：如一致性哈希，确保流量合理分配。
- **安全拦截**：WAF（Web 应用防火墙）过滤恶意请求（如 SQL 注入）。

#### 2. 业务逻辑处理

- **缓存策略**：
  - Redis 缓存热点数据，防止数据库雪崩。
  - 缓存穿透用 Bloom Filter 拦截。
- **数据库查询**：
  - 通过索引优化（如覆盖索引）减少磁盘 I/O。
  - 读写分离降低主库压力。

#### 3. 生成响应

- **响应头关键字段**：
  - `Content-Type`（MIME 类型）。
  - `Cache-Control`（CDN 缓存策略）。
  - `ETag`（协商缓存）。
- **压缩与分块传输**：
  - `gzip` 压缩响应体。
  - 大文件使用 `Transfer-Encoding: chunked` 流式传输。

---

### 三、浏览器渲染阶段：从字节到像素

#### 1. 解析与构建关键数据结构

- **DOM 树**：HTML 解析器逐行解析，遇到 `<script>` 会阻塞（除非 `async/defer`）。
- **CSSOM 树**：外链 CSS 文件下载并解析，`@import` 导致串行加载（建议内联关键 CSS）。
- **预加载扫描器**：提前发现图片、JS 等资源，并行下载减少等待。

#### 2. 渲染流水线（Critical Rendering Path）

- **渲染树合成**：合并 DOM 和 CSSOM，排除 `display: none` 节点。
- **布局（Layout）**：计算元素几何信息（重排触发条件：修改宽度、字体大小等）。
- **绘制（Paint）**：将布局转换为屏幕像素，分层渲染（GPU 加速 `transform` 避免重绘）。

#### 3. JavaScript 执行与优化

- **V8 引擎**：即时编译（JIT）将热点代码转为机器码，隐藏类加速对象访问。
- **事件循环**：宏任务（`setTimeout`）、微任务（`Promise`）优先级调度，`requestIdleCallback` 处理非紧急任务。

---

### 四、性能与安全纵深优化

#### 1. 网络层优化

- **CDN 加速**：静态资源推送到边缘节点，减少 RTT。
- **HTTP/3**：基于 QUIC 协议解决 TCP 队头阻塞，支持连接迁移（网络切换不断连）。

#### 2. 浏览器层优化

- **资源预加载**：`<link rel="preload">` 提前加载关键字体、图片。
- **代码分割**：Webpack 动态加载非首屏代码，减少主线程阻塞。

#### 3. 安全加固

- **CSP 头**：限制脚本来源，防止 XSS 攻击。
- **SRI（子资源完整性）**：哈希校验 CDN 资源防止篡改。

---

## 总结

整个过程涉及 **网络协议栈、操作系统内核、浏览器引擎、分布式系统** 的深度协作。现代优化手段（如 HTTP/3、Server Push、Service Worker）将加载时间压缩至毫秒级。理解每个环节的瓶颈（如 DNS 延迟、TCP 慢启动、主线程长任务）并针对性优化（预解析、连接复用、代码分割），是构建高性能 Web 应用的核心。
