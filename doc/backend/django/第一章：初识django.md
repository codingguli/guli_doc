## 第一章：初识 django

### 启动 django 项目

:::info 虚拟环境安装 django

- 安装虚拟环境

```shell
pip -m venv myvenv
```

- 启动虚拟环境

```shell
myvnev\Scripts\activate
```

- 安装 django

```shell
pip install django
```

- 创建文件夹

```shell
mkdir djangotutorial
```

- 基于 djangotutorial 文件创建项目

```shell
django-admin startproject mysite djangotutorial
```

- 进入项目目录

```shell
cd .\djangotutorial\
```

- 启动项目

```shell
python manage.py runserver
```

:::

### django 文件目录介绍

:::info django 文件目录介绍

- 文件目录

```txt
djangotutorial/
    manage.py
    mysite/
        __init__.py
        settings.py
        urls.py
        asgi.py
        wsgi.py
```

> - manage.py：管理 django 项目的命令行工具
> - mysite/settings.py：django 的配置文件
> - mysite/urls.py：django 的路由文件
> - mysite/asgi.py：运行在 ASGI 兼容的 Web 服务器上的入口
> - mysite/wsgi.py：运行在 WSGI 兼容的 Web 服务器上的入口

:::

### 创建应用

:::info 创建应用

- 脚本

```shell
python manage.py startapp polls
```

- 文件目录

```txt
polls/
    __init__.py
    admin.py
    apps.py
    migrations/
        __init__.py
    models.py
    tests.py
    urls.py
    views.py
```

:::

### 创建视图

:::info 创建第一个视图

- 创建视图

`polls/views.py`

```py
from django.http import HttpResponse
def index(req):
  return HttpResponse('polls的index视图')
```

- 创建子路由

`polls/urls.py`

```py
from django.urls import path
from . import views

urlpatterns = [
  path('', views.index, name="index")
]
```

- 关联子路由

`mysite/urls.py`

```py
from django.urls import path, include

urlpatterns = [
  path('polls/', include("polls.urls"))
]
```

- 访问 localhost:8000/polls

> 显示"polls 的 index 视图"

:::

### 创建模型

:::info 创建模型

- 运行迁移，生成系统表

```shell
python manage.py migrate
```

- 创建模型

`polls/models.py`

```py
from django.db import models

class Question(models.Model):
  question_text = models.CharField(max_length=200)
  pub_date = models.DateTimeField("date published")

class Choice(models.Model):
  question = models.ForeignKey(Question, on_delete=models.CASCADE)
  choice_text = models.CharField(max_length=200)
  votes = models.IntegerField(default=0)
```

- 生成迁移文件

```shell
python manage.py makemigrations polls
```

> polls/migrations 下生成了`0001_initial.py`文件

- 查看迁移 sql

```shell
python manage.py sqlmigrate polls 0001
```

> 这个 sqlmigrate 命令并没有真正在你的数据库中的执行迁移 - 相反，它只是把命令输出到屏幕上，让你看看 Django 认为需要执行哪些 SQL 语句

`执行后，命令行生成`

```sql
BEGIN;
--
-- Create model Question
--
CREATE TABLE "polls_question" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "question_text" varchar(200) NOT NULL,
    "pub_date" timestamp with time zone NOT NULL
);
--
-- Create model Choice
--
CREATE TABLE "polls_choice" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "choice_text" varchar(200) NOT NULL,
    "votes" integer NOT NULL,
    "question_id" bigint NOT NULL
);
ALTER TABLE "polls_choice"
  ADD CONSTRAINT "polls_choice_question_id_c5b4b260_fk_polls_question_id"
    FOREIGN KEY ("question_id")
    REFERENCES "polls_question" ("id")
    DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "polls_choice_question_id_c5b4b260" ON "polls_choice" ("question_id");

COMMIT;
```

- 运行迁移

```shell
python manage.py migrate
```

- 变更模型

> - 手动编辑`models.py`
> - 执行`python manage.py makemigrations`
> - 执行`python manage.py migrate`

:::

### 创建管理员账号

:::info 创建管理员账号

- 命令

```shell
python manage.py createsuperuser
```

- 输入用户名

```shell
Username: admin
```

- 输入密码

```shell
Email address: admin@example.com
```

- 输入密码

```shell
Password: **********
Password (again): *********
Superuser created successfully.
```

- 访问 localhost:8000/admin

> 即可对表进行增删改查了

:::

### 在管理页面加入应用

:::info 在管理页面加入应用

- 注册应用
  `polls/admin.py`

```py
from django.contrib import admin
from .models import Question

admin.site.register(Question)
```

- 访问 localhost/admin/

> 即可对 Question 模型的表进行增删改查了

:::

### 使用模板

#### 创建视图

:::info 创建视图

- 创建视图

`polls/views.py`

```py
from django.http import HttpResponse
def detail(request, question_id):
    return HttpResponse(f"我是polls的detail视图{question_id}")

def results(request, question_id):
    return HttpResponse(f"我是polls的results视图{question_id}")

def vote(request, question_id):
    return HttpResponse(f"我是polls的vote视图{question_id}")
```

- 新增路由

`polls/urls.py`

```py{6-8}
from django.urls import path
from .views import *

urlpatterns = [
    path('', index, name="index"),
    path('<int:question_id>/', detail, name="detail"),
    path('<int:question_id>/results/', results, name="results"),
    path('<int:question_id>/vote/', vote, name="vote")
]
```

- 从数据库获取数据进行返回

`polls/views.py`

```py
from dango.http import HttpResponse
from .models import Question

def index(req):
  latest_question_list = Question.objects().order_by("-pub_date")[:5]
  output = ",".join([question.question_text for question in latest_question_list])
  return HttpResponse(output)
```

:::

#### 使用模板

:::info 使用模板

- 视图给模板传参

```py
# 写法一
from django.http import HttpResponse
from django.urls import load
from .models import Question

def index(req):
  latest_question_list = Question.objects.order_by("-pub_date")[:5]
  template = load.get_template('polls/index.html')
  context = {
    "latest_question_list": latest_question_list
  }
  return HttpResponse(template.render(context,req))

# 写法二
from django.shortcuts import render
from .models import Question

def index(req):
  latest_question_list = Question.objects.order_by("-pub_date")[:5]
  context = {
    "latest_question_list": latest_question_list
  }
  return render(req, 'polls/index.html', context)
```

- 渲染模板数据

`polls/templates/polls/index.html`

```xml{8-18}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    {% if latest_question_list %}
    	<ul>
            {% for question in latest_question_list %}
                <li>
                    <a href="/polls/{{ question.id }}">{{ question.question_text }}</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        暂无数据
    {% endif %}
</body>
</html>
```

:::

#### 使用模板 404 情况

:::info 使用模板 404 情况

- 视图给模板传参

`polls/views.py`

```py
# 方式一
from django.shortcuts import render
from django.http import Http404

from .models import Question
def detail(req, question_id):
  try:
    question = Question.objects.get(pk=question_id)
    context = {
      "question": question
    }
  except Question.DoesNotExist:
    raise Http404("question does not exist")
  return render(req, 'polls/detail.html', )


# 方式二
from django.shortcuts import render, get_object_or_404
from .models import Question

def detail(req, question_id):
  question = get_object_or_404(Question, pk=question_id)
  context = {
    "question": question
  }
  return render(req, 'polls/detail.html', context)
```

- 渲染模板数据

`polls/templates/polls/detail.html`

```xml{8}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h1>{{ question.question_text }}</h1>
</body>
</html>
```

- 将硬编码改为`{% url %} `格式

`polls/templates/polls/index.html`

```xml{12}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    {% if latest_question_list %}
    	<ul>
            {% for question in latest_question_list %}
                <li>
                    <a href="{% url 'detail' question.id %}">{{ question.question_text }}</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        暂无数据
    {% endif %}
</body>
</html>
```

- 为 URL 名称添加命名空间

`polls/urls.py`

```py{1}
app_name = 'polls'
urlpatterns = [
    path('', index, name="index"),
    path('<int:question_id>/', detail, name="detail"),
    path('<int:question_id>/results/', results, name="results"),
    path('<int:question_id>/vote/', vote, name="vote")
]
```

`polls/templates/polls/index.html`

```xml{12}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    {% if latest_question_list %}
    	<ul>
            {% for question in latest_question_list %}
                <li>
                    <a href="{% url 'polls:detail' question.id %}">{{ question.question_text }}</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        暂无数据
    {% endif %}
</body>
</html>
```

:::

### 使用表单

#### 简单的使用表单

:::info 简单的使用表单

`polls/templates/polls/detail`

- 模板

```xml
<form action="{% url 'polls:vote' question.id %}" method="post">
{% csrf_token %}
<fieldset>
    <legend><h1>{{ question.question_text }}</h1></legend>
    {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
    {% for choice in question.choice_set.all %}
        <input type="radio" name="choice" id="choice{{ forloop.counter }}" value="{{ choice.id }}">
        <label for="choice{{ forloop.counter }}">{{ choice.choice_text }}</label><br>
    {% endfor %}
</fieldset>
<input type="submit" value="Vote">
</form>
```

- 视图

`polls/views.py`

```py
from django.shortcuts import get_object_or_404
from django.http import HttpResponseRedirect
from django.db.models import F
from django.urls import reverse
from .models import Question

def vote(request, question_id):
    question = get_object_or_404(Question, pk=question_id)
    try:
        selected_choice = question.choice_set.get(pk=request.POST["choice"])
    except (KeyError, Choice.DoesNotExist):
        context = {
            "question": question,
            "error_message": "You didn't select a choice.",
        }
        return render(request, "polls/detail.html", context)
    else:
        selected_choice.votes = F("votes") + 1
        selected_choice.save()
        return HttpResponseRedirect(reverse("polls:results", args=(question.id,)))
```

> - request.POST：是一个类字典对象，request.POST['choice'] 以字符串形式返回选择的 Choice 的 ID。 request.POST 的值永远是字符串。如果在 request.POST['choice'] 数据中没有提供 choice ， POST 将引发一个 KeyError 。
> - F("votes") + 1 指示数据库 将投票数增加 1，在成功处理 POST 数据后，你应该总是返回一个 HttpResponseRedirect。
> - reverse：反解析`/polls/1/results`

:::

#### 使用通用视图（目前还不知道这玩意的咋实现的）

:::info 使用通用视图

`polls/views.py`

- 视图

```py
from django.views import generic
from .models import Question

class IndexView(generic.ListView):
    template_name = "polls/index.html"
    context_object_name = "latest_question_list"

    def get_queryset(self):
        """Return the last five published questions."""
        return Question.objects.order_by("-pub_date")[:5]


class DetailView(generic.DetailView):
    model = Question
    template_name = "polls/detail.html"


class ResultsView(generic.DetailView):
    model = Question
    template_name = "polls/results.html"
```

- 路由

`polls/urls.py`

```py
from . import views

urlpatterns = [
    path('', views.IndexView.as_view(), name="index"),
    path('<int:pk>/', views.DetailView.as_view(), name="detail"),
    path('<int:pk>/results/', views.ResultsView.as_view(), name="results"),
    path('<int:question_id>/vote/', views.vote, name="vote")
]
```

:::
